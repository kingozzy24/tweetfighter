<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Test</title>
	
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script type="text/javascript">
		//twitter
		function Player(hash) {
			this.hash = hash;
			this.health = 100;
			this.pastInformation = 0;
			this.numTweets = 0;
		}
		
		Player.prototype.toString = function() {
			return "Health: " + this.health + ", Tweets: " + this.numTweets;
		}
		
		$(document).ready(function(){
			$('#button').click(function(){
				start();
			});
			
			$('#firstBox').keypress(function(event){
				if (event.which == 13)
					start();
			});
			
			$('#secondBox').keypress(function(event){
				if (event.which == 13)
					start();
			});
		});
		
		//timer
		function start(){
			loadShit();
			$('#firstBox').attr("disabled", "disabled");
			$('#secondBox').attr("disabled", "disabled");
			player1 = new Player(document.getElementById("firstBox").value);
			player2 = new Player(document.getElementById("secondBox").value);
			if (player1.hash.charAt(0) == '#')
				player1.hash = player1.hash.substring(1);
			if (player2.hash.charAt(0) == '#')
				player2.hash = player2.hash.substring(1);
				
			firstUpdate(player1);
			firstUpdate(player2);
			
			setInterval(function(){update()}, 5000);
		}
		
		function firstUpdate(player) {
			var req = $.ajax({
				type: 'GET',
				dataType: 'jsonp',
				url: 'http://search.twitter.com/search.json?q=%23'+player.hash+"&result_type=recent&rpp=1&include_entities=true&since_id="+player.pastInformation,
				success: function(data) {
					player.numTweets = 0;
					player.pastInformation = data.max_id;
					console.log(data);
					$('#error').empty();
				},
				error: function(xhr, status, errorThrown) {
					player.numTweets = 0;
					console.log(errorThrown);
					$('#error').empty();
					$('#error').append("Error :(. Try again?");
					$('#textbox').attr("disabled", false);
				}
			});
		}
		
		function update() {
			getTweets(player1);
			getTweets(player2);
			if (player1.numTweets > player2.numTweets)
				player2.health -= 10;
			if (player2.numTweets > player1.numTweets)
				player1.health -= 10;

			debugInfo();
			console.log(player1);
			console.log(player2);
		}
		
		//get tweets
		function getTweets(player) {
			$('#tweets').empty();
			$('#error').empty();
			$('#error').append("Sending request...");
			
			var req = $.ajax({
				type: 'GET',
				dataType: 'jsonp',
				url: 'http://search.twitter.com/search.json?q=%23'+player.hash+"&result_type=recent&rpp=100&include_entities=true&since_id="+player.pastInformation,
				success: function(data) {
					player.numTweets = 0;
					player.pastInformation = data.max_id;
					console.log(data);
					$('#error').empty();
					if (data.max_id != data.since_id)
						player.numTweets = data.results.length;
				},
				error: function(xhr, status, errorThrown) {
					player.numTweets = 0;
					console.log(errorThrown);
					$('#error').empty();
					$('#error').append("Error :(. Try again?");
					$('#textbox').attr("disabled", false);
				}
			});
		}
		
		function debugInfo() {
			$('#tweets').empty();
			var row = document.createElement("tr");
			var d1 = document.createElement("td");
			var d2 = document.createElement("td");
			
			$(d1).append(player1.toString());
			$(d2).append(player2.toString());
			$(row).append(d1);
			$(row).append(d2);
			$('#tweets').append(row);
		}
	</script>
	
	<style type="text/css">
		body {
			font-family: monospace;
			text-align: center;
		}
		table {
			border: 2px solid black;
			border-collapse: collapse;
		}
		td {
			border: 1px solid black;
			padding: 4px;
		}
		#error {
			font-style: italic;
			color: red;
		}
	</style>
</head>

<body>
<script type="text/javascript">
//canvas
		function Sprite(source){
			this.img = new Image();
			this.img.src = source[0];
			this.position = {x: 0, y:0};
			this.origin = {x:0, y:0};
			this.rotation = 0;
			this.scale = {x:.2, y:.2};
			this.children = new Array();
		}

		Sprite.prototype.draw = function(context){
			context.save();
			context.translate(this.position.x, this.position.y);
			context.scale(this.scale.x, this.scale.y);
			context.rotate(this.rotation);
			context.translate(-this.origin.x, -this.origin.y);
			context.drawImage(this.img, 0,0);
			for(var i = 0; i < this.children.length; i++){
				this.children[i].draw(context);
			}
			context.restore();
		};
		
		function loadShit() {
			var seattleSet = new Array();
			for(var i = 1; i <= 7; i++){
				var temp = new Image().src = "photos/Seattle"+i+".png";
				seattleSet.push(temp);
			} 
			var SFset = new Array();
			for(var i = 1; i <= 7; i++){
				var temp = new Image().src = "photos/SanFran"+i+".png";
				SFset.push(temp);
			}
		
			var player1 = new Sprite(seattleSet);
			var player2 = new Sprite(SFset);
			var c = document.getElementById("myCanvas");
			var ctx=c.getContext("2d");
			player1.position = {x : 10, y: 10};
			player2.position = {x : c.width-250, y: 10};
			setInterval(function(){
				c.width = c.width;
				player1.draw(ctx);
				player2.draw(ctx);
			},1000/60); 
		}
</script>
	<h2>Enter a hashtag!</h2>
	<div>
		<input type="text" id="firstBox" value="#CodeDaySEA">
		<input type="button" id="button" value="Submit">
	</div>
		<input type = "text" id = "secondBox" value = "#CodeDaySF">
	<div>
	</div>
	<br>
	<div id="error"></div>
	<table id="tweets" align=center></table>
	<canvas id="myCanvas" width="800" height="495" style="border:1px solid #c3c3c3;">
	Your browser does not support the HTML5 canvas tag.
	</canvas>
</body>

</html>